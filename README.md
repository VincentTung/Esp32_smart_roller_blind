# ESP32 智能卷帘控制系统

一个基于ESP32和A4988步进电机驱动器的智能卷帘控制系统，支持红外遥控操作和时间设置功能。

## 项目概述

本项目实现了一个智能卷帘控制系统，通过ESP32微控制器驱动42步进电机来控制卷帘的开关。系统支持红外遥控操作，并具有设置模式，允许用户自定义卷帘的开关时间。

## 主要功能

- **红外遥控控制**：支持多种遥控操作
- **时间设置模式**：可自定义卷帘开关时间
- **流畅转动**：带加速减速的平滑转动
- **数据持久化**：时间设置保存到EEPROM
- **防抖处理**：避免误操作
- **实时监控**：串口输出详细状态信息

## 硬件连接

### 主要组件
- ESP32 开发板
- A4988 步进电机驱动器
- 42步进电机
- 0038k 红外接收模块
- 12V 电源适配器

### 引脚连接
```
ESP32 GPIO 16 -> A4988 STEP
ESP32 GPIO 17 -> A4988 DIR  
ESP32 GPIO 18 -> A4988 ENABLE (可选)
ESP32 GPIO 19 -> 红外接收模块 OUT
ESP32 3.3V    -> A4988 VDD, 红外接收模块 VCC
ESP32 GND     -> A4988 GND, 红外接收模块 GND
12V电源       -> A4988 VMOT
12V电源GND    -> A4988 GND
```

## 红外遥控器功能

| 按键 | 命令码 | 功能 |
|------|--------|------|
| 上键 | 0x1 | 打开窗帘（顺时针转动指定时间） |
| 下键 | 0x9 | 关闭窗帘（逆时针转动指定时间） |
| 左键 | 0x4 | 顺时针转动45度 |
| 右键 | 0x6 | 逆时针转动45度 |
| 设置键 | 0xE | 进入/退出设置模式 |
| 0键 | 0x0 | 停止电机/连续3次清除存储 |

## 设置模式使用说明

1. **进入设置模式**：按下设置键（0xE）
2. **开始计时**：系统自动开始关闭窗帘并计时
3. **停止计时**：窗帘完全关闭后，再次按下设置键
4. **保存设置**：系统自动保存新的开关时间到EEPROM
5. **退出设置**：按0键可随时退出设置模式

## 技术参数

- **步进电机**：42步进电机，200步/圈
- **微步进**：1/16微步进（3200步/圈）
- **默认速度**：300步/秒（最大扭矩模式）
- **默认开关时间**：5000毫秒
- **红外协议**：支持0038k红外接收模块
- **存储**：EEPROM存储用户设置

## 软件特性

### 防抖机制
- 正常模式：200ms防抖时间
- 设置模式：1000ms防抖时间
- 电机运行时：立即响应停止命令

### 流畅转动
- 支持加速减速曲线
- 最大速度：400步/秒
- 最小速度：100步/秒
- 加速/减速步数：总步数的1/4

### 数据管理
- 自动保存用户设置到EEPROM
- 启动时自动加载保存的设置
- 支持恢复默认设置（连续按3次0键）

## 安装和使用

### 1. 硬件准备
- 按照引脚连接图连接所有组件
- 确保12V电源能够提供足够电流驱动步进电机
- 检查所有连接是否牢固

### 2. 软件安装
1. 安装Arduino IDE
2. 安装ESP32开发板支持包
3. 安装IRremote库：`IRremote`
4. 安装EEPROM库（通常已包含在ESP32支持包中）

### 3. 上传代码
1. 打开`sketch_sep7a.ino`文件
2. 选择正确的ESP32开发板
3. 选择正确的串口
4. 上传代码到ESP32

### 4. 首次使用
1. 打开串口监视器（115200波特率）
2. 观察系统启动信息和电机测试
3. 使用红外遥控器测试各项功能
4. 如需自定义开关时间，进入设置模式

## 故障排除

### 常见问题

1. **电机不转动**
   - 检查12V电源连接
   - 检查A4988驱动器连接
   - 确认ENABLE引脚状态

2. **红外遥控无响应**
   - 检查0038k模块连接
   - 确认遥控器电池电量
   - 查看串口输出的红外信号

3. **转动不准确**
   - 进入设置模式重新校准时间
   - 检查机械连接是否牢固
   - 调整电机速度参数

4. **设置无法保存**
   - 检查EEPROM写入权限
   - 重新上传代码
   - 使用连续3次0键清除存储

## 开发说明

### 代码结构
- `setup()`: 初始化硬件和读取设置
- `loop()`: 主循环，处理红外信号和电机控制
- `handleIRCommand()`: 红外命令处理
- `rotateForTime()`: 时间控制转动
- `smoothRotate()`: 流畅转动
- `handleSetKey()`: 设置模式处理

### 可调参数
```cpp
const int STEPS_PER_REVOLUTION = 200;  // 步进电机步数
const int MICROSTEPS = 16;             // 微步进设置
int speed = 300;                       // 电机速度
int CURTAIN_TIME = 5000;               // 默认开关时间
```

## 许可证

本项目采用开源许可证，详见LICENSE文件。

## 贡献

欢迎提交Issue和Pull Request来改进这个项目。

## 联系方式

如有问题或建议，请通过GitHub Issues联系。

---

**注意**：使用前请确保所有连接正确，电源电压符合要求，避免损坏硬件。